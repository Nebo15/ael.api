language: elixir
sudo: required
cache:
  directories:
    - deps
    - _build
services:
  - docker
elixir:
  - 1.4.2
otp_release:
  - 19.3
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=edenlabllc
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    - HEROKU_APP_NAME="ael"
    - secure: "CuSNUHcRy6X7AkLLDerH6qrVnxHMUjG1ke9aSjxdhKEjhQ1lIBlVVpz6X3lyvJIZt+nGfu/qGUSDVUucMpXL22Th4BU/2cTOVv+RDd9bHGIePZtZC4ehWhucKgSqSEhDSmSq4Qd7YFmNPSuRDIcHiukQPiPAq5RrZw3zw1HvQWPM/BmIyg1IgAl3tHf8uLisjzenIjwVPELlF15M1c6Lrfe/YVtS3TpnWgdsMGR6IjZU2NkbRqW+/FPmP1socetshpxn0RXgMgkLbz1CdCbVYIfPGBq4QKMafXncGC39MaiA3nm3gBL/Tn3CWk7MC0jPZLwex72n9Dc32lQpomFBzubk8ufsCSKR+GHf7lUKq8K2uUJRvAb0LI5Q+YOWVSrHiEp8e+R4Jbz1CiqmS5LZG7pBp0n9WHbV+ra51zCcHOIiv+uB2mR9krkbw8Ehm5/bFL2mHb11ztEs9mAcm4w29ZhBIQ+tZLsVIM/ignLasEmizRk2U2nsW1asai/YYI2LCY+Cj+0mLldY1KfQoMN5nN+oj8L2Qszt+Sww5mjPbHbfWfY2daZyvwcXXox/N7MYoTYNtSWEXHmtHd0yMFCgUzclOv/4xjqkfSbmX7XpTmiVxHcgeRAmx/9cfyw0w4MgJJz7/8cw+vdLGhM8IclH/34QsJwd+yK4378GDlyVuwY="
    - secure: "mKvK2AXlB3NSUOLrAi+9IQsJvRfzh6EsaM35RfSiZZnLawF3sJUOgw6qrhSewK3XVpfz5W+VYymTId4/Tj1dlTRkkeprsSE6SymNBIqyjfILMTBTYu3qH1631EcYOlXi7k1Z7tQwTqt4KkGYEQ8MSAA/qYrsPsixctHMAk5pE81J0+HJYkkrifRdIW0PA4tCJZBMmHBXbeoeVU0lGn+qnHiZcLd/Fik7+qYtPX26IgjRQqqVEGtTDAakH9RP1KrcXtxp84N/hBOUWbTFXSeajYQYxDXuc9BY8+Ud2puEwQHrcSa54E5+GLro85xDsQBR6l3iJLxmeP3VdKzqzPgE1EuC0xjTw7VxRlFAdJT8GYXHjwXhnAJtiy/9cYpWaQjO02l1BmdQEUxMP5dnZQFxX5mabyPVNc0oSdmtEe5FwNmGnKlQ5eVAQP2nFjTH/H7p8NtaD/7RyYBYPsY55BdbhSXPYgq+ssnf8serL32UBk5hKv10CKBMr5effPhTsCP5DvuVN0JDPb0y1kKL6f2Un0DqbyYpOV0+2/AEF0uemt4eGot9ayDIB3qkrILkWEtA/0lBax4+9F7Qdt8hIGAoUrLKeQ192EsQiPcpy4NIZ+Cz6+wpxlDt8skLY15IxTEHiiIkI9VIvQbFMCqVEgJGCAGBpRTpwJc8TknGeXV36no="
    - secure: "A28VAicvlcqprk446xKHlTU73H/qUoxfWml6efHoxQx4/aKsNNDk3ty+1NgNEmgvMmhb1JCYgBq7psPx/JaYr3quTAmB3vv94X3sSUFThDp01CK46paMNybdqhPD9uRSrl7QfTSgCyMGSFFVDK+Ld6kKY9RH/68h8BTnrbg3wU5o5Oa3rrJrIjRp2+VKV0FSWNi2P6haF9oBaHtmBn5nH9Ss+FZsXTSv7hYz6SZ2b5ao9LGD6XQ2QKBq7rJHy/O2+cz6ccswvR716kWOLTCFCKFMCVk57ltbYE+bfeXQYGidUWv3Fpfq83sf+NXy5Kfva9SyblktAuRh695WonBQ0HlYHwJ0pP42ITIugqJWHyuAlqsHKWxBprxD4Tueh0FZ18eDkwtjRpjgIBnkUuuwlaCdHPlvgpM4JwEleTlE6nkz+LrxdDJXFNgyaZ3dc8S5wK7T3XxEJXJeWEwcDjDpmk/pQ9fOYYTpIU8XoeBLS6/Q4wsO9q/QqvpCGgUJ0KdgxnFTPH+Dx4tMwBqrBs5n84ec5lh6Mk5g9U0XOpi6zDbZn9pn+G626kiBnc3Dw3NEWoOhiNO7BaCeImnbHK4pcfV9P8GyDB4dcS9FyzPLQQ+62ntC/oVymAA5sLM+J2PU/K6EKKpSdwrQY4Xj1rfvP6rCrIly/vH4McoBQkz8eiA="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  openssl aes-256-cbc -K $encrypted_2fbea6458a09_key -iv $encrypted_2fbea6458a09_iv -in priv/secret.enc -out priv/service_account_key.json -d
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies if Travis won't do it by default
  # - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  # Add --pro if you using private repo.
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs ael_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/acceptance"
after_failure:
  - docker logs ael_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
  # CD to Heroku
  - ./bin/ci/deploy.sh
